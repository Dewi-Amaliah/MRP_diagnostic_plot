---
title: "mrp_build"
author: "Dewi Lestari Amaliah - 31251587"
date: "03/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mrpkit)
library(brms)
library(tidyverse)
library(tictoc)
```

## Using mrpkit to build model

1. Base model: age, race_ethnicity (collapsed race_ethnicity), state, gender. Outcome would be future vote 
2. Additional predictor: Base model + education
3. Model with additional level: age, race_ethnicity (original race_ethnicity), state, gender. Outcome would be future vote
4. Model 2 with 3 different outcome , i.e., future vote (CC16_410a), early vote (CC16_364b), and party preference (pid3).

```{r}
# read the data

cces <- read_rds(here::here("data/cces_use.rds"))
acs <- read_rds(here::here("data/acs_use_wrangled.rds"))
```

## Create SurveyData object for the cces and acs data

Model 1 is the base model, with age, race_ethnicity (collapsed race_ethnicity), and state as the predictor. The outcome would be the future vote. 

```{r surveydata}
# pre-process the cces data for base model
cces_mrp <- cces %>%
  # rename variable as mrpkit workflow
  rename(wt = commonweight) %>%
  mutate(vote_post_nonbinary = as.character(CC16_410a),
         vote_early_nonbinary = as.character(CC16_364b),
         party_nonbinary = as.character(pid3)) %>%
  # mutate the outcome which is vote for Donald Trump (yes/no) in post vote
  # mutate the outcome which is vote for Donald Trump (yes/no) in early vote
  # mutate the outcome which is identified as Republican (yes) or no
  mutate( 
    vote_post = as.factor(ifelse(vote_post_nonbinary == "Donald Trump (Republican)", "yes, vote Trump", "no, will not vote Trump")),
    vote_early = as.factor(ifelse(vote_early_nonbinary == "Donald Trump (Republican)", "yes, vote Trump", "no, did not vote Trump")),
    party = as.factor(ifelse(party_nonbinary == "Republican", "yes, I am", "no, I am not"))
    ) %>%
  mutate(race_ethnicity = as_factor(race_ethnicity)) %>%
  select(age, inputstate, race_ethnicity_collp, race_ethnicity, gender, educ, 
         vote_post, vote_early, party, wt)

# drop the level since we don't want any unused level be in the SurveyData object
cces_mrp$gender <- droplevels(cces_mrp$gender)
cces_mrp$inputstate <- droplevels(cces_mrp$inputstate)
cces_mrp$educ <- droplevels(cces_mrp$educ)


#### CREATE SURVEYDATA OBJECT
# create survey data object for the survey data
cces_data_obj <- SurveyData$new(
  data = cces_mrp,
  questions = list(age = "Respondent's age group",
                   inputstate = "State",
                   race_ethnicity_collp = "Respondent's race/ethnicity collapsed Native American, Middle Eastern, and Other to Other",
                   race_ethnicity = "Respondent's race/ethnicity original level",
                   gender = "Respondent's gender",
                   educ = "Respondent's education",
                   vote_post = "Whether the respondent vote for Donald Trump in 2016 President vote (Post)",
                   vote_early = "Whether the respondent vote for Donald Trump in 2016 President vote (Early)",
                   party = "Whether the respondent identify him/herself as Republican or not"),
  responses = list(age = levels(cces_mrp1$age),
                   inputstate = levels(cces_mrp1$inputstate),
                   race_ethnicity_collp = levels(cces_mrp1$race_ethnicity_collp),
                   race_ethnicity = levels(cces_mrp1$race_ethnicity),
                   gender = levels(cces_mrp1$gender),
                   educ = levels(cces_mrp1$educ),
                   vote_post = c("no, will not vote Trump", "yes, vote Trump"),
                   vote_early = c("no, did not vote Trump", "yes, vote Trump"),
                   party = c("no, I am not", "yes, I am")),
 weights = "wt")
# this step: 0.039 sec elapsed


# pre-process the acs data for base model
acs_mrp <- acs %>%
  # filter out the respondents whose age < 18 years because they are not in the scope of CCES survey?
  filter(age != "Less than 18 years") %>%
  select(state, wt, age, sex, race_ethnicity, race_ethnicity_collps, educ_collps)

# drop unused level in age variable
acs_mrp$age <- droplevels(acs_mrp$age)

# create survey data object for the post-stratification data 
acs_data <- SurveyData$new(
  data = acs_mrp,
  questions = list(age = "Respondent's age group",
                   state = "State",
                   sex = "Respondent's gender",
                   race_ethnicity_collps = "Respondent's race/ethnicity recoded",
                   race_ethnicity = "Respondent's race/ethnicity",
                   educ_collps = "Respondent's highest educational attainment"),
  responses = list(age = levels(acs_mrp$age),
                   state = levels(acs_mrp$state),
                   sex = levels(acs_mrp$sex),
                   race_ethnicity_collps = levels(acs_mrp$race_ethnicity_collps),
                   race_ethnicity = levels(acs_mrp$race_ethnicity),
                   educ_collps = levels(acs_mrp$educ_collps)),
  weights = "wt"
)
# this step: 0.641 sec elapsed

# print the object
# acs_data$print()
# this step: 58.992 sec elapsed
```


**Note:**
1. Re-check if using the `inputstate` (pre-election state name) or inputstate_post (post-election state name)


## Create QuestionMapping object 

Even though we have 3 different outcomes and model with various predictors, we can still do question mapping at once, just like shown as follows:

```{r questionmapping}

#### QUESTION MAPPING
q_age <- QuestionMap$new(
  name = "age",
  col_names = c("age", "age"),
  values_map = list(
    "18-25" = "18-25",
    "26-35" = "26-35",
    "36-45" = "36-45",
    "46-55" = "46-55",
    "56-65" = "56-65",
    "66-75" = "66-75",
    "76 years and over" = "76-90",
    "76 years and over" = "over 90 years"))

q_state <- QuestionMap$new(
  name = "state",
  col_names = c("inputstate", "state"),
  values_map = list(
    "Alabama" = "Alabama",
    "Alaska" = "Alaska",
    "Arizona" = "Arizona",
    "Arkansas" = "Arkansas",
    "California" = "California",
    "Colorado" = "Colorado",
    "Connecticut" = "Connecticut",
    "Delaware" = "Delaware",
    "District of Columbia" = "District of Columbia",
    "Florida" = "Florida",
    "Georgia" = "Georgia",
    "Hawaii" = "Hawaii",
    "Idaho" = "Idaho",
    "Illinois" = "Illinois",
    "Indiana" = "Indiana",
    "Iowa" = "Iowa",
    "Kansas" = "Kansas",
    "Kentucky" = "Kentucky",
    "Louisiana" = "Louisiana",
    "Maine" = "Maine",
    "Maryland" = "Maryland",
    "Massachusetts" = "Massachusetts",
    "Michigan" = "Michigan",
    "Minnesota" = "Minnesota",
    "Mississippi" = "Mississippi",
    "Missouri" = "Missouri",
    "Montana" = "Montana",
    "Nebraska" = "Nebraska",
    "Nevada" = "Nevada",
    "New Hampshire" = "New Hampshire",
    "New Jersey" = "New Jersey",
    "New Mexico" = "New Mexico",
    "New York" = "New York",
    "North Carolina" = "North Carolina",
    "North Dakota" = "North Dakota",
    "Ohio" = "Ohio",
    "Oklahoma" = "Oklahoma",
    "Oregon" = "Oregon",
    "Pennsylvania" = "Pennsylvania",
    "Rhode Island" = "Rhode Island",
    "South Carolina" = "South Carolina",
    "South Dakota" = "South Dakota",
    "Tennessee" = "Tennessee",
    "Texas" = "Texas",
    "Utah" = "Utah",
    "Vermont" = "Vermont",
    "Virginia" = "Virginia",
    "Washington" = "Washington",
    "West Virginia" = "West Virginia",
    "Wisconsin" = "Wisconsin",
    "Wyoming" = "Wyoming"))

q_gender <- QuestionMap$new(
  name = "gender",
  col_names = c("gender", "sex"),
  values_map = list(
    "Male" = "Male",
    "Female" = "Female"))

q_recollapsed <- QuestionMap$new(
  name = "collapsed_re",
  col_names = c("race_ethnicity_collp", "race_ethnicity_collps"),
  values_map = list(
    "Asian" = "Asian alone",
    "Black" = "Black or African American alone",
    "Hispanic" = "Hispanic",
    "Other" = "Other",
    "Mixed" = "Two or More Races",
    "White" = "White alone"))

q_re <- QuestionMap$new(
  name = "original_re",
  col_names = c("race_ethnicity", "race_ethnicity"),
  values_map = list(
    "White" = "White alone",
    "Asian" = "Asian alone",
    "Hispanic" = "Hispanic",
    "Black" = "Black or African American alone",
    "Mixed" = "Two or More Races",
    "Native American" = "American Indian and Alaska Native tribes",
    "Native American" = "American Indian alone",
    "Native American" = "Alaska Native alone",
    "Other" = "Some Other Race alone",
    "Other" = "Native Hawaiian and Other Pacific Islander alone",
    "Middle Eastern" = "Some Other Race alone"))

q_educ <- QuestionMap$new(
  name = "education",
  col_names = c("educ", "educ_collps"),
  values_map = list(
    "No HS" = "No high school",
    "High school graduate" = "Regular high school diploma",
    "Some college" = "Some college",
    "2-year" = "Associate's degree",
    "4-year" = "Bachelor's degree",
    "Post-grad" = "Post-graduate"))
```


## Create SurveyMap Object

Just like the previous step, we only create one SurveyMap object here for all of the model

```{r}
## SURVEY MAPPING STEP
map_model <- SurveyMap$new(sample = cces_data_obj,
                            population = acs_data,
                            q_age,
                            q_state,
                            q_gender,
                            q_recollapsed, 
                            q_re,
                            q_educ)

map_model$validate()
map_model$mapping()
map_model$tabulate()

saveRDS(map_model, here::here("results/map_model.rds"))
```


## Model Fitting

```{r fit, eval = FALSE}
# Recheck: Is it okay to map all the variable here even though it is not included in the model?
# This takes a long time to run (26589.7 seconds)

### FIT THE MODEL

# Model 1
fit1 <- map_model$fit(
  fun = brms::brm,
  formula = vote_post ~ (1|age) + (1|gender) + (1+state) + (1|collapsed_re),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 2
fit2 <- map_model$fit(
  fun = brms::brm,
  formula = vote_post ~ (1|age) + (1|gender) + (1+state) + (1|collapsed_re) + (1|education),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 3
fit3 <- map_model$fit(
  fun = brms::brm,
  formula = vote_post ~ (1|age) + (1|gender) + (1+state) + (1|original_re),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 4a
fit4a <- map_model4a$fit(
  fun = brms::brm,
  formula = vote_early ~ (1|age) + (1|gender) + (1+state) + (1|collapsed_re) + (1|education),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 4b
fit4b <- map_model4b$fit(
  fun = brms::brm,
  formula = party ~ (1|age) + (1|gender) + (1+state) + (1|collapsed_re) + (1|education),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)
```

```{r}
# read the fit1.rds
fit1 <- readRDS("results/fit1.rds")
fit1_predict <- fit1$population_predict()
# 65.759 sec elapsed
```


## Question to clarify:

1. Re-check if using the `inputstate` (pre-election state name) or inputstate_post (post-election state name)
2. Regarding the binary outcome, is it okay if it is vote Donald Trump/not?
3. For the early vote outcome, there are probably more NAs then the vote_post (future vote).
4. Recheck: Is it okay to map all the variable here even though it is not included in the model?
5. Is it okay to keep using the question mapping from the base model even though the outcomes are different?