---
title: "mrp_build"
author: "Dewi Lestari Amaliah - 31251587"
date: "03/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(mrpkit)
library(brms)
library(tidyverse)
library(tictoc)
library(ggplot2)
```

## Using mrpkit to build model

1. Base model: age, race_ethnicity (collapsed race_ethnicity), state, gender. Outcome would be vote (voted_pres_16)
2. Additional predictor: Base model + education
3. Model with additional level: age, race_ethnicity (original race_ethnicity), state, gender. Outcome would be vote (voted_pres_16)
4. Model 2 with 2 other outcome , i.e., intent(intent_pres_16) and party identity (pid3).

```{r}
# read the data

cces <- read_rds(here::here("data/cces_use.rds"))
acs <- read_rds(here::here("data/acs_use_wrangled.rds"))
```

## Create SurveyData object for the cces and acs data

Model 1 is the base model, with age, race_ethnicity (collapsed race_ethnicity), and state as the predictor. The outcome would be the future vote. 

```{r surveydata}
# pre-process the cces data for base model
cces_mrp <- cces %>%
  # rename variable as mrpkit workflow
  rename(wt = weight) %>%
  # mutate the outcome which is vote for Donald Trump (yes/no) in post vote
  # mutate the outcome which is vote for Donald Trump (yes/no) in early vote
  # mutate the outcome which is identified as Republican (yes) or no
  mutate( 
    vote = as.factor(ifelse(voted_pres_16 == "Donald Trump", "yes", "no")),
    intent = as.factor(ifelse(intent_pres_16 == "Donald Trump (Republican)", "yup", "nah")),
    party = as.factor(ifelse(pid3 == "Republican", "Republican", "not Republican"))
    )

#### CREATE SURVEYDATA OBJECT
# create survey data object for the survey data
cces_data_obj <- SurveyData$new(
  data = cces_mrp,
  questions = list(age = "Respondent's age group",
                   state = "State",
                   race_ethnicity_collp = "Respondent's race/ethnicity collapsed Native American, Middle Eastern, and Other to Other",
                   race = "Respondent's race/ethnicity original level",
                   gender = "Respondent's gender",
                   educ = "Respondent's education",
                   vote = "Whether the respondent vote for Donald Trump in 2016 Presidential vote (Post)",
                   intent = "Whether the respondent intent to vote for Donald Trump in 2016 Presidential vote",
                   party = "Whether the respondent identify him/herself as Republican or not"),
  responses = list(age = levels(cces_mrp$age),
                   state = levels(cces_mrp$state),
                   race_ethnicity_collp = levels(cces_mrp$race_ethnicity_collp),
                   race = levels(cces_mrp$race),
                   gender = levels(cces_mrp$gender),
                   educ = levels(cces_mrp$educ),
                   vote = c("no", "yes"),
                   intent = c("nah", "yup"),
                   party = c("Republican", "not Republican")),
 weights = "wt")
# this step: 0.039 sec elapsed


# pre-process the acs data for base model
acs_mrp <- acs %>%
  # filter out the respondents whose age < 18 years because they are not in the scope of CCES survey?
  filter(age != "Less than 18 years") %>%
  select(state, wt, age, sex, race_ethnicity, race_ethnicity_collps, educ_collps)

# drop unused level in age variable
acs_mrp$age <- droplevels(acs_mrp$age)

# create survey data object for the post-stratification data 
acs_data <- SurveyData$new(
  data = acs_mrp,
  questions = list(age = "Respondent's age group",
                   state = "State",
                   sex = "Respondent's gender",
                   race_ethnicity_collps = "Respondent's race/ethnicity recoded",
                   race_ethnicity = "Respondent's race/ethnicity",
                   educ_collps = "Respondent's highest educational attainment"),
  responses = list(age = levels(acs_mrp$age),
                   state = levels(acs_mrp$state),
                   sex = levels(acs_mrp$sex),
                   race_ethnicity_collps = levels(acs_mrp$race_ethnicity_collps),
                   race_ethnicity = levels(acs_mrp$race_ethnicity),
                   educ_collps = levels(acs_mrp$educ_collps)),
  weights = "wt"
)
# this step: 0.641 sec elapsed

# print the object
# acs_data$print()
# this step: 58.992 sec elapsed
```


**Note:**
1. Re-check if using the `inputstate` (pre-election state name) or inputstate_post (post-election state name)


## Create QuestionMapping object 

Even though we have 3 different outcomes and model with various predictors, we can still do question mapping at once, just like shown as follows:

```{r questionmapping}

#### QUESTION MAPPING
q_age <- QuestionMap$new(
  name = "age",
  col_names = c("age", "age"),
  values_map = list(
    "18 to 24 years" = "18-24",
    "25 to 34 years" = "25-34",
    "35 to 44 years" = "35-44",
    "45 to 64 years" = "45-54",
    "45 to 64 years" = "55-64",
    "65 years and over" = "65-74",
    "65 years and over" = "75-89",
    "65 years and over" = "90 years and over"))
   
q_state <- QuestionMap$new(
  name = "state",
  col_names = c("state", "state"),
  values_map = list(
    "Alabama" = "Alabama",
    "Alaska" = "Alaska",
    "Arizona" = "Arizona",
    "Arkansas" = "Arkansas",
    "California" = "California",
    "Colorado" = "Colorado",
    "Connecticut" = "Connecticut",
    "Delaware" = "Delaware",
    "District of Columbia" = "District of Columbia",
    "Florida" = "Florida",
    "Georgia" = "Georgia",
    "Hawaii" = "Hawaii",
    "Idaho" = "Idaho",
    "Illinois" = "Illinois",
    "Indiana" = "Indiana",
    "Iowa" = "Iowa",
    "Kansas" = "Kansas",
    "Kentucky" = "Kentucky",
    "Louisiana" = "Louisiana",
    "Maine" = "Maine",
    "Maryland" = "Maryland",
    "Massachusetts" = "Massachusetts",
    "Michigan" = "Michigan",
    "Minnesota" = "Minnesota",
    "Mississippi" = "Mississippi",
    "Missouri" = "Missouri",
    "Montana" = "Montana",
    "Nebraska" = "Nebraska",
    "Nevada" = "Nevada",
    "New Hampshire" = "New Hampshire",
    "New Jersey" = "New Jersey",
    "New Mexico" = "New Mexico",
    "New York" = "New York",
    "North Carolina" = "North Carolina",
    "North Dakota" = "North Dakota",
    "Ohio" = "Ohio",
    "Oklahoma" = "Oklahoma",
    "Oregon" = "Oregon",
    "Pennsylvania" = "Pennsylvania",
    "Rhode Island" = "Rhode Island",
    "South Carolina" = "South Carolina",
    "South Dakota" = "South Dakota",
    "Tennessee" = "Tennessee",
    "Texas" = "Texas",
    "Utah" = "Utah",
    "Vermont" = "Vermont",
    "Virginia" = "Virginia",
    "Washington" = "Washington",
    "West Virginia" = "West Virginia",
    "Wisconsin" = "Wisconsin",
    "Wyoming" = "Wyoming"))

q_gender <- QuestionMap$new(
  name = "gender",
  col_names = c("gender", "sex"),
  values_map = list(
    "Male" = "Male",
    "Female" = "Female"))

q_recollapsed <- QuestionMap$new(
  name = "collapsed_re",
  col_names = c("race_ethnicity_collp", "race_ethnicity_collps"),
  values_map = list(
    "Asian" = "Asian alone",
    "Black" = "Black or African American alone",
    "Hispanic" = "Hispanic",
    "Other" = "Other",
    "Other" = "Two or More Races",
    "White" = "White alone"))

q_re <- QuestionMap$new(
  name = "original_re",
  col_names = c("race", "race_ethnicity"),
  values_map = list(
    "Black" = "Black or African American alone",
    "White" = "White alone",
    "Hispanic" = "Hispanic",
    "All Other" = "Some Other Race alone",
    "Native American" = "American Indian and Alaska Native tribes",
    "All Other" = "Two or More Races",
    "Asian" = "Asian alone",
    "Native American" = "American Indian alone",
    "All Other" = "Native Hawaiian and Other Pacific Islander alone",
    "Native American" = "Alaska Native alone"))
    

q_educ <- QuestionMap$new(
  name = "education",
  col_names = c("educ", "educ_collps"),
  values_map = list(
    "HS or Less" = "No high school",
    "HS or Less" = "Regular high school diploma",
    "Some College" = "Some college",
    "Some College" = "Associate's degree",
    "4-Year" = "Bachelor's degree",
    "Post-Grad" = "Post-graduate"))
```


## Create SurveyMap Object

Just like the previous step, we only create one SurveyMap object here for all of the model

```{r}
## SURVEY MAPPING STEP
map_model <- SurveyMap$new(sample = cces_data_obj,
                            population = acs_data,
                            q_age,
                            q_state,
                            q_gender,
                            q_recollapsed, 
                            q_re,
                            q_educ)

map_model$mapping()
map_model$tabulate()

#saveRDS(map_model, here::here("results/map_model.rds"))
```


## Model Fitting

```{r fit, eval = FALSE}
# Recheck: Is it okay to map all the variable here even though it is not included in the model?
# This takes a long time to run (26589.7 seconds)

### FIT THE MODEL

# Model 1
fit1 <- map_model$fit(
  fun = brms::brm,
  formula = vote ~ (1|age) + (1|gender) + (1|state) + (1|collapsed_re),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 2
fit2 <- map_model$fit(
  fun = brms::brm,
  formula = vote ~ (1|age) + (1|gender) + (1|state) + (1|collapsed_re) + (1|education),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 3
fit3 <- map_model$fit(
  fun = brms::brm,
  formula = vote ~ (1|age) + (1|gender) + (1|state) + (1|original_re),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 4a
fit4a <- map_model$fit(
  fun = brms::brm,
  formula = intent ~ (1|age) + (1|gender) + (1|state) + (1|collapsed_re) + (1|education),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)

# Model 4b
fit4b <- map_model$fit(
  fun = brms::brm,
  formula = party ~ (1|age) + (1|gender) + (1|state) + (1|collapsed_re) + (1|education),
  family = "bernoulli",
  refresh = 100,
  cores = 2,
  backend = "cmdstanr"
)
```


# Model 1 

```{r}
# read the fit1.rds
fit1 <- readRDS(here::here("results/fit1.rds"))

fit1_predict <- fit1$population_predict()
# 13.626 sec elapsed


age_estimation <- fit1$aggregate(fit1_predict, by = "age")
# 3.771 sec elapsed

state_estimation <- fit1$aggregate(fit1_predict, by = "state")
# 9.03 sec elapsed

popn_estimation <- fit1$aggregate(fit1_predict)
# 1.194 sec elapsed

state_estimation %>%
  group_by(state) %>%
  summarize(mean = mean(value), sd = sd(value))
```

```{r}
plot_popn <- fit1$plot(popn_estimation) 
plot_popn
```

```{r}
fit1$plot(age_estimation, weights = TRUE)
```


Next goal:

## Use the g2016 for the ground truth 
## Replicate the plot:
1. State on the y-axis and mrp-estimate on the x-axis / choropleth map 
2. Scatter plot between MRP estimate and ground truth
5. Comparison between the 3 outcomes
6. Comparison between the different predictors (original re, collapsed re, and education)

Next: 
3. Scatter plot between MRP estimate and direct estimate (to get the uncertainty use the survey package)
survey::svydesign(ids=~1, weight = "w in original data frame", mean)
mean = survey::surveymean
4. plot the MRP estimate with the performance criteria (MSE)
7. Descriptive statistic about the obs using in the model (i.e., the n vote trump, not vote, and missing for the 3 outcomes)
8. Check again the levels in the outcome. 

## Question to clarify:

1. Re-check if using the `inputstate` (pre-election state name) or inputstate_post (post-election state name)
2. Regarding the binary outcome, is it okay if it is vote Donald Trump/not?
3. For the early vote outcome, there are probably more NAs then the vote_post (future vote).
4. Recheck: Is it okay to map all the variable here even though it is not included in the model?
5. Is it okay to keep using the question mapping from the base model even though the outcomes are different?